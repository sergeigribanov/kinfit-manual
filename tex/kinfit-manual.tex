\input{bhead.tex}

\title[кинематический фит]{Пакет кинематической реконструкции для детектора КМД-3}
\date{\today}
\begin{document}

\begin{frame} 
\titlepage
\end{frame}

\begin{frame}{Кинематическая реконструкция}
  \footnotesize
  Процедура кинематической реконструкции заключается в поиске условного минимума
  функции хи-квадрат: $\chi^2(\vec{x}) = \sum\limits^{N}_{i =
    1}\Delta{\vec{x}}^\intercal_i\mathcal{A}_i\Delta{\vec{x}}_i$, где $i$ --
  номер частицы, $N$ -- количество частиц, $\Delta{\vec{x}}_i = \vec{x}_i -
  \vec{x}^0_i$ -- разница вектора значений параметров $i$-й частицы на текущей
  итерации ($\vec{x}_i$) и вектора измеренных значений параметров $i$-й частицы
  ($\vec{x}^0_i$), $\mathcal{A}_i$ -- обратная матрица ошибок для измеренных
  параметров $i$-й частицы, $\vec{x}=\{\vec{x}_1, \vec{x}_2, ..., \vec{x}_N\}$. Требуется
  выполнение $M$ условий вида $c_j(\vec{x},\vec{y}) = 0$, где $j=1, 2, ..., M$,
  $\vec{y}$ --- вектор неизмеряемых параметров (натуральный параметр трека,
  координаты общей вершины). Поиск условного минимума функции $\chi^2(\vec{x})$
  эквивалентен поиску безусловного минимума функции $\mathcal{L}(\vec{q}) =
  \chi^2(\vec{x}) + \sum\limits^M_{j = 1}\lambda_jc_j(\vec{x}, \vec{y})$, где
  $\lambda_j$ -- лагранжевы множители, $\vec{q} = \{\vec{x}, \vec{y}, \vec{\lambda}\}$.
  
  Уравнеие $\nabla\mathcal{L}(\vec{q}) = 0$ решается численно с помощью
  многомерного метода Ньютона: $\vec{q}_{k + 1} = \vec{q}_{k} -
  \mathcal{H}^{-1}(\vec{q}_k)\nabla\mathcal{L}(\vec{q}_{k})$, где $\mathcal{H}$
  -- гессиан функции $\mathcal{L}(\vec{q})$.
\end{frame}

\begin{frame}{Основные возможности и особенности}
  \scriptsize
  \begin{itemize}
  \item Градиент и гессиан функции $\mathcal{L}(\vec{q})$ заданы вручную.
  \item Есть возможность численного расчета градиента и гессиана функции
    $\mathcal{L}(\vec{q})$. Однако численный счет производных работает
    значительно медленнее, а для стабильной работы кинематической реконструкции
    в этом случае необходимо правильно выбрать шаг диффиренцирования (сейчас
    один для всех параметров).
  \item Используется библиотека Eigen3. Остальные два пакета кинематической
    реконструкции, применяющиеся коллаборацией КМД-3, используют библиотеки
    линейной алгебры из фреймворка ROOT.
  \item Далее под \textit{частицами} будут пониматься частицы в конечном
    состоянии. Только для таких частиц в пакете кинематической реконструкции
    заведены отдельные классы.
  \item Иногда речь будет идти о
    \textit{промежуточных частицах}. Отдельные классы для таких частиц не
    заведены в пакете кинематической реконструкции для КМД-3 (в этом нет
    необходимости). Однако, зная вершины и рождения и распада для таких частиц,
    можно найти вектора направлений их импульсов. Эти вектора могут быть
    использованы в условиях на уголы между импульсами промежуточных частиц и
    суммарными импульсами их продуктов распада.
  \end{itemize}
\end{frame}

\begin{frame}{Основные возможности и особенности}
  \begin{itemize}
    \scriptsize
  \item Имеется параметризация заряженных частиц и фотонов для детектора КМД-3.
  \item Имеется параметризация четырех-импульса массивных частиц c использованием
    трех декартовых компонент импульса: $(\sqrt{p^2_x + p^2_y +
      p^2_z + m^2}, p_x, p_y, p_z)$.
  \item Имеется параметризация четырех-импульса безмассовых частиц с
    использованием параметров энергии, полярного и азимутального углов:
    $(E, E\sin\theta\cos\phi, E\sin\theta\sin\phi, E\cos\theta)$.
  \item Возможность проводить кинематическую реконструкцию в гипотезах с
    потерянными частицами.
  \item Условия на выполнения законов сохранения энергии-импульса.
  \item Условие на инвариантную массу группы частиц.
  \item Условия на вылет группы частиц из единой вершины. В случае
    детектора КМД-3 эти условия накладывается только на заряженные
    частицы. Для фотонов это условие выполняется по построению зависимости
    комонент четырех-импульса фотона от параметров фотона и координат вершины.
  \item В событии может присутствовать несколько вершин.
  \end{itemize}
\end{frame}

\begin{frame}{Параметризация}
  \scriptsize
  \fcolorbox{red}{red}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}-- измеряемые
  параметры ($\vec{x}$),\hfill
  \fcolorbox{magenta}{magenta}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}-- неизмеряемые
  параметры ($\vec{y}$),\hfill
  \fcolorbox{cadmiumgreen}{cadmiumgreen}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}-- константы
  
  \textbf{Параметризация четырех-импульса заряженной частицы (КМД-3):}
  $\textcolor{blue}{\mathcal{P} = (\textcolor{cyan}{\varepsilon},
    \textcolor{cyan}{p_x}, \textcolor{cyan}{p_y}, \textcolor{cyan}{p_z})}$, где
  $\textcolor{cyan}{p_x}\textcolor{blue}{=\textcolor{red}{p_{\perp}}
    \cos{(\textcolor{cyan}{\frac{\omega}{c}}\textcolor{magenta}{ct}
      - \textcolor{red}{\phi_0})} }$, $\textcolor{cyan}{p_y}\textcolor{blue}{=
    -\textcolor{red}{p_{\perp}}\sin{(\textcolor{cyan}{\frac{\omega}{c}}\textcolor{magenta}{ct}
      - \textcolor{red}{\phi_0})}}$,
  $\textcolor{cyan}{p_z}\textcolor{blue}{=}\textcolor{red}{p_{\perp}}\textcolor{red}{\ctg\theta}$,
  $\textcolor{cyan}{\varepsilon}\textcolor{blue}{=
    \sqrt{\textcolor{red}{p^{\textcolor{blue}{2}}_{\perp}}(1 +
      \textcolor{red}{\ctg^{\textcolor{blue}{2}}\theta}) +
      \textcolor{cadmiumgreen}{m}^2} }$,
  $\textcolor{cyan}{\frac{\omega}{c}}\textcolor{blue}{=
    \frac{\textcolor{cadmiumgreen}{q\mathcal{B}k_c}}{\textcolor{cyan}{\varepsilon}}}$,
  $\textcolor{cadmiumgreen}{k_c}\textcolor{blue}{\approx 2.9979}$, $\textcolor{cadmiumgreen}{\mathcal{B}}$
  -- магнитное поле~(Тл), $\textcolor{cadmiumgreen}{q}$ -- заряд
  частицы~(ед. эл. заряда), $\textcolor{cadmiumgreen}{m}$ -- масса
  частицы~(МэВ), $\textcolor{red}{p_{\perp}}$ -- перпендикулярная оси $Z$
  компонента импульса частицы~(МэВ), $\textcolor{red}{\ctg\theta}$ -- котангенс
  угла между импульсом частицы и осью $Z$, $\textcolor{red}{\phi_0}$ --
  аксиальный угол импульса частицы~(рад.) в ближайшей к оси пучков точке трека,
  $\textcolor{magenta}{ct}$ -- натуральный параметр трека~(см).
  
  \textbf{Параметризация трека в ДК (КМД-3):}
  $\textcolor{blue}{(\textcolor{cyan}{x},
    \textcolor{cyan}{y},
    \textcolor{cyan}{z})}$ -- координаты точки на треке, $\textcolor{cyan}{x}
  \textcolor{blue}{=\textcolor{cadmiumgreen}{x_b} + (\textcolor{cyan}{R} -
    \textcolor{red}{\rho_0})\sin\textcolor{red}{\phi_0} +
    \textcolor{cyan}{R}\sin{(\textcolor{cyan}{\frac{\omega}{c}}\textcolor{magenta}{ct}
      - \textcolor{red}{\phi_0})}}$,
  
  $\textcolor{cyan}{y}\textcolor{blue}{=\textcolor{cadmiumgreen}{y_b} -
    (\textcolor{cyan}{R} - \textcolor{red}{\rho_0})\cos\textcolor{red}{\phi_0} +
    \textcolor{cyan}{R}\cos{(\textcolor{cyan}{\frac{\omega}{c}}\textcolor{magenta}{ct}
      - \textcolor{red}{\phi_0})} }$,
  $\textcolor{cyan}{z}\textcolor{blue}{=\textcolor{red}{z_0} +
    \frac{\textcolor{red}{p_{\perp}}}{\textcolor{cadmiumgreen}{q\mathcal{B}k_c}}}$,

  $\textcolor{blue}{(\textcolor{cadmiumgreen}{x_b},
    \textcolor{cadmiumgreen}{y_b})}$ -- координаты оси пучков~(см),
  $\textcolor{red}{\rho_0}$ -- расстояние~(см) от трека до оси пучков с учетом
  знака (ось пучков внутри спирали -- <<$+$>>, снаружи -- <<$-$>>),
  $\textcolor{red}{z_0}$ -- $z$-координата~(см) ближайшей к оси пучков точке на треке.
  
  \textbf{Параметризация четырех-импульса фотона (КМД-3):} $\textcolor{blue}{\mathcal{P}
    = (\textcolor{red}{\varepsilon},
    \textcolor{cyan}{p_x},
    \textcolor{cyan}{p_y},
    \textcolor{cyan}{p_z})}$, где $\textcolor{cyan}{p_x}\textcolor{blue}{=
    \textcolor{red}{\varepsilon}\frac{\textcolor{cyan}{x_c} -
      \textcolor{magenta}{x_v}}{\textcolor{cyan}{l_c}} }$,
  $\textcolor{cyan}{p_y}\textcolor{blue}{=
    \textcolor{red}{\varepsilon}\frac{\textcolor{cyan}{y_c} -
      \textcolor{magenta}{y_v}}{\textcolor{cyan}{l_c}} }$,
  $\textcolor{cyan}{p_z}\textcolor{blue}{=
    \textcolor{red}{\varepsilon}\frac{\textcolor{red}{z_c} -
      \textcolor{magenta}{z_v}}{\textcolor{cyan}{l_c}} }$,
  $\textcolor{cyan}{x_c}\textcolor{blue}{=
    \textcolor{red}{R_c}\cos\textcolor{red}{\phi_c}}$,
  $\textcolor{cyan}{y_c}\textcolor{blue}{=
    \textcolor{red}{R_c}\sin\textcolor{red}{\phi_c}}$,
  $\textcolor{cyan}{l_c}\textcolor{blue}{=\sqrt{
      (\textcolor{cyan}{x_c} - \textcolor{magenta}{x_v})^2 +
      (\textcolor{cyan}{y_c} - \textcolor{magenta}{y_v})^2 +
      (\textcolor{red}{z_c} - \textcolor{magenta}{z_v})^2}}$,
  $\textcolor{blue}{(\textcolor{cyan}{x_c},
    \textcolor{cyan}{y_c},
    \textcolor{red}{z_c})}$ -- точка конверсии фотона~(см),
  $\textcolor{blue}{(\textcolor{magenta}{x_v},
    \textcolor{magenta}{y_v}, \textcolor{magenta}{z_v})}$ -- вершина вылета
  фотона~(см), $\textcolor{red}{\varepsilon}$ -- энергия фотона~(МэВ),
  $\textcolor{red}{R_c}$ -- радиус точки конверсии~(см),
  $\textcolor{red}{\phi_c}$ -- азимутальный
  угол точки конверсии фотона~(рад.).
\end{frame}

\begin{frame}{Параметризация и условия}
  \scriptsize
  \fcolorbox{red}{red}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}-- измеряемые
  параметры ($\vec{x}$),\hfill
  \fcolorbox{magenta}{magenta}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}-- неизмеряемые
  параметры ($\vec{y}$),\hfill
  \fcolorbox{cadmiumgreen}{cadmiumgreen}{\rule{0pt}{4pt}\rule{4pt}{0pt}}\quad\hspace{-0.5em}--
  константы
  
  \textbf{Параметризация четырех-импульса улетевшей частицы с массой $m_l$:}
  $\mathcal{P} = (\sqrt{p^2_x + p^2_y + p^2_z + m^2_l}, p_x, p_y, p_z)$.

  \textbf{Параметризация четырех-импульса безмассовой улетевшей частицы:}
  $\mathcal{P} = (\varepsilon_l, \varepsilon_l\sin\theta_l\cos\phi_l,
  \varepsilon_l\sin\theta_l\sin\phi_l, \varepsilon_l\cos\theta_l)$.

  \textbf{Условие на з.с. энергии-импульса:}
  $\textcolor{blue}{\sum\limits_i\textcolor{cyan}{p^{\textcolor{blue}{i}}_x} =
    0}$,
  $\textcolor{blue}{\sum\limits_i\textcolor{cyan}{p^{\textcolor{blue}{i}}_y} =
    0}$,
  $\textcolor{blue}{\sum\limits_i\textcolor{cyan}{p^{\textcolor{blue}{i}}_z} =
    0}$,
  $\textcolor{blue}{\sum\limits_i\textcolor{cyan}{\varepsilon^{\textcolor{blue}{i}}}
    - 2\textcolor{cadmiumgreen}{\varepsilon_b} = 0}$, где
  $\textcolor{cadmiumgreen}{\varepsilon_b}$ -- энергия в пучке.
  
  \textbf{Условие на координаты вершины заряженной частицы:}
  $\textcolor{blue}{\textcolor{cyan}{x} - \textcolor{magenta}{x_v} = 0}$,
  $\textcolor{blue}{\textcolor{cyan}{y} - \textcolor{magenta}{y_v} = 0}$,
  $\textcolor{blue}{\textcolor{cyan}{z} - \textcolor{magenta}{z_v} = 0}$, где
  $\textcolor{blue}{(\textcolor{cyan}{x}, \textcolor{cyan}{y},
    \textcolor{cyan}{z})}$ -- точка на треке в зависимости от параметров (в том
  числе и от натурального параметра трека $\textcolor{magenta}{ct}$),
  $\textcolor{blue}{(\textcolor{magenta}{x_v}, \textcolor{magenta}{y_v},
    \textcolor{magenta}{z_v})}$ -- координаты вершины, из которой вылетела
  заряженная частица.

  \textit{Требование на вылет фотона из определенной вершины выполняется
    автоматически, по построению параметризации четырех-импульса фотона.}

  \textbf{Условие на инвариантную массу группы частиц:}
  $\textcolor{blue}{(\sum\limits_{\alpha}\textcolor{cyan}{\varepsilon}^{\alpha})^2
    - (\sum\limits_{\alpha}\textcolor{cyan}{\vec{p}}^{\alpha})^2 -
    \textcolor{cadmiumgreen}{M}^2 = 0}$, где $\textcolor{cadmiumgreen}{M}$ --
  требуемое значение инвариантной массы.
  
  \textbf{Условие на угол между импульсом промежуточной частицы и суммарным импульсом
    продуктов ее распада.}
\end{frame}

\begin{frame}{$e^+e^-\rightarrow\eta\pi^+\pi^-\rightarrow{2(\pi^+\pi^-)\pi^0}$}
  \footnotesize
  Моделирование процесса в вершине $(5\,{\rm cm}, -3\,{\rm cm}, 2\,{\rm cm})$.
  \begin{minipage}{0.45\textwidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{etapipi_5pi_vtx_x}
      \vspace{-0.2cm}
      \caption{\scriptsize $x$-координата вершины, определенная из фита.\label{fig:etapipi_5pi_vtx_x} }
    \end{figure}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\textwidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{etapipi_5pi_vtx_y}
      \vspace{-0.2cm}
      \caption{\scriptsize $y$-координата вершины, определенная из фита.\label{fig:etapipi_5pi_vtx_y} }
    \end{figure}
  \end{minipage}
  \begin{minipage}{0.45\textwidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{etapipi_5pi_vtx_z}
      \vspace{-0.2cm}
      \caption{\scriptsize $z$-координата вершины, определенная из фита.\label{fig:etapipi_5pi_vtx_z} }
    \end{figure}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\textwidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{etapipi_5pi_vtx_m3pi}
      \vspace{-0.2cm}
      \caption{\scriptsize Инвариантная масса $\pi^+\pi^-\pi^0$.\label{fig:etapipi_5pi_m3pi} }
    \end{figure}
  \end{minipage}
\end{frame}

\begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}\pi$}
  \footnotesize
  \begin{minipage}{0.45\linewidth}
    \includegraphics[width=0.8\linewidth]{kskpi_schema}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\linewidth}
    \begin{itemize}
      \item $x, y$-координаты пучковой вершины $0$ фиксированы на положении оси
        пучков, $z$-координата пучковой вершины свободна,
        \item $x, y, z$-координаты вершины $1$ распада ${\rm K}^0_{\rm
            S}\rightarrow\pi^+\pi^-$ свободны,
          \item из $8$ перестановок заряженных частиц выбирается перестановка,
            отвечающая наименьшему $\chi^2$.
    \end{itemize}
  \end{minipage}
  \begin{minipage}{0.45\linewidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{kskpi_noflow_mks}
      \vspace{-0.2cm}
      \caption{Инвариантная масса $\pi^+_1\pi^-_1$.\label{fig:kskpi_mks} }
    \end{figure}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\linewidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{kskpi_noflow_chi2}
      \vspace{-0.2cm}
      \caption{$\chi^2$ кинематической реконструкции.\label{fig:kskpi_chi2} }
    \end{figure}
  \end{minipage}
\end{frame}

\begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}\pi$}
  \footnotesize
  \vspace{1em}%
  \begin{minipage}{0.45\linewidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.7\linewidth]{kskpi_noflow_dr}
      \vspace{-0.2cm}
      \caption{Отлет <<${\rm K}_{\rm S}$>>.\label{fig:kskpi_noflow_dr} }
    \end{figure}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\linewidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.7\linewidth]{kskpi_noflow_vtx_z}
      \vspace{-0.2cm}
      \caption{$z$-координаты вершин.\label{fig:kskpi_noflow_vtx_z} }
    \end{figure}
  \end{minipage}
  \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.7\linewidth]{kskpi_noflow_vtx1_xy}
        \vspace{-0.2cm}%
        \caption{Распределение координат вершины распада в $XY$ плоскости.\label{fig:kskpi_noflow_vtx1_xy}}
      \end{figure}
  \end{minipage}
\end{frame}

 \begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}\pi$}
  \footnotesize
  \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.7\linewidth]{kskpi_noflow_pdedx_k}
        \vspace{-0.2cm}%
        \caption{${\rm dE}/{\rm dx}({\rm P})$ для <<${\rm K}^{\pm}$>>.\label{fig:kskpi_noflow_pdedx_k}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.7\linewidth]{kskpi_noflow_pdedx_pibeam}
        \vspace{-0.2cm}%
        \caption{${\rm dE}/{\rm dx}({\rm P})$ для $\pi$-мезонов из пучковой вершины.\label{fig:kskpi_noflow_pdedx_pibeam}}
      \end{figure}
    \end{minipage}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.7\linewidth]{kskpi_noflow_pdedx_pivertex}
        \vspace{-0.2cm}%
        \caption{${\rm dE}/{\rm dx}({\rm P})$ для $\pi$-мезонов из вершины
          распада <<${\rm K}_{\rm S}$>>.\label{fig:kskpi_noflow_pdedx_pivertex}}
      \end{figure}
    \end{minipage}
\end{frame}

\begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}\pi$: констрейн на
    направление ${\rm K}_{\rm S}$}
  \footnotesize
  
    Констрейнов на з.с. энергии-импульса и вершины не достаточно для того, чтобы
    импульс ${\rm K}_{\rm S}$ равнялся суммарному импульсу продуктов распада
    ${\rm K}_{\rm S}$.

    \textbf{Констрейн на косинус угла:} $\frac{(\Delta\vec{r}, \vec{p})}{\|\Delta\vec{r}\|\|\vec{p}\|} - 1 =
    0$ -- эффективность реконструкции получается ниже, чем при использовании
    \textbf{констрейнов на коллинераность:} $\Delta{y}p_z - \Delta{z}p_y = 0$,
    $\Delta{z}p_x - \Delta{x}p_z = 0$, $\Delta{x}p_y - \Delta{y}p_x =
    0$.
    
    \begin{minipage}{0.45\linewidth}
      \includegraphics[width=0.8\linewidth]{flow_constraint_schema}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{kskpi_dirang}
        \vspace{-0.2cm}%
        \caption{Угол $\alpha$.\label{fig:kskpi_dirang}}
      \end{figure}
    \end{minipage}
\end{frame}

\begin{frame}{Потеря частиц и $e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}_{\rm
      L}\pi^0$}
  \footnotesize
  \textbf{Параметризация четырех-импульсов улетевших частиц:}
  $\textcolor{blue}{\mathcal{P}=(\sqrt{
      \textcolor{magenta}{p^{\textcolor{blue}{2}}_x} +
    \textcolor{magenta}{p^{\textcolor{blue}{2}}_y} +
    \textcolor{magenta}{p^{\textcolor{blue}{2}}_z} +
    \textcolor{cadmiumgreen}{m}^2},
  \textcolor{magenta}{p_x},
  \textcolor{magenta}{p_y},
  \textcolor{magenta}{p_z})}$ -- для частицы с массой
$\textcolor{cadmiumgreen}{m}$,
$\textcolor{blue}{\mathcal{P} =
  (\textcolor{magenta}{\varepsilon},
  \textcolor{magenta}{\varepsilon}\sin\textcolor{magenta}{\theta}\cos\textcolor{magenta}{\phi},
  \textcolor{magenta}{\varepsilon}\sin\textcolor{magenta}{\theta}\sin\textcolor{magenta}{\phi},
  \textcolor{magenta}{\varepsilon}\cos\textcolor{magenta}{\theta})}$ --- для
безмассовой частицы.

\textbf{Кинематическая реконструкция для событий моделирования
  $e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}_{\rm L}\pi^0$.} ${\rm K}_{\rm L}$ --
улетевшая частица. Две вершины: пучковая
и вершина распада ${\rm K}_{\rm S}\rightarrow\pi^+\pi^-$. Перебор по всем парам фотонов.
Выбирается пара фотонов, отвечающая наименьшему значению хи-квадрат
кинематической реконструкции. \textcolor{red}{\textit{Необходим констрейн на направление
  импульса ${\rm K}_{\rm S}$-мезона.}}

\begin{minipage}{0.45\linewidth}
  \begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\linewidth]{ksklpi0_dr}
      \vspace{-0.2cm}%
      \caption{Отлет <<${\rm K}_{\rm S}$>>.\label{fig:ksklpi0_dr}}
    \end{figure}
  \end{minipage}
  \hspace{1em}%
  \begin{minipage}{0.45\linewidth}
    \begin{figure}[ht]
      \centering
      \includegraphics[width=0.8\linewidth]{ksklpi0_vtx0_z}
      \vspace{-0.2cm}%
      \caption{$Z$-координата пучковой вершины.\label{fig:ksklpi0_vtx0_z}}
    \end{figure}
  \end{minipage}
\end{frame}

\begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}_{\rm L}\pi^0$}
  \footnotesize
  \vspace{1em}
  \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksklpi0_vtx1_z}
        \vspace{-0.2cm}%
        \caption{$Z$-координата вершины распада <<${\rm K}_{\rm S}$>>.\label{fig:ksklpi0_vtx1_z}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksklpi0_flow_chi2}
        \vspace{-0.2cm}%
        \caption{$\chi^2$ кинематической реконструкции.\label{fig:ksklpi0_flow_chi2}}
      \end{figure}
    \end{minipage}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksklpi0_flow_mks}
        \vspace{-0.2cm}%
        \caption{Инвариантная масса $\pi^+\pi^-$.\label{fig:ksklpi0_flow_mks}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
    %\vspace{-1.2cm}%
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksklpi0_flow_mgg}
        \vspace{-0.2cm}%
        \caption{Инвариантная масса $\gamma\gamma$.\label{fig:ksklpi0_flow_mgg}}
      \end{figure}
    \end{minipage}
  \end{frame}

  \begin{frame}{$e^+e^-\rightarrow{\rm K}_{\rm S}{\rm K}_{\rm S}\pi^+\pi^-$}
    \footnotesize
    \vspace{1em}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksks_minv}
        \vspace{-0.2cm}%
        \caption{Инвариантная масса одного из <<${\rm K}_{\rm S}$>>.\label{fig:ksks_minv}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      %\vspace{0.1cm}%
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksks_chi2}
        \vspace{-0.2cm}%
        \caption{$\chi^2$ кинематической реконструкции.\label{fig:ksks_chi2}}
      \end{figure}
    \end{minipage}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{ksks_dr}
        \vspace{-0.2cm}%
        \caption{Отлеты обоих <<${\rm K}_{\rm S}$>>.\label{fig:ksks_dr}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      Три вершины. Из $36$ возможных перестановок заряженных частиц выбирается
      перестановка, отвечающая минимальному хи-квадрат кинематической реконструкции.
    \end{minipage}
  \end{frame}

  \begin{frame}{$e^+e^-\rightarrow\pi^0\gamma$}
    \footnotesize
    \vspace{1em}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{pi0gamma_mgg}
        \vspace{-0.2cm}%
        \caption{Инвариантная масса $\gamma\gamma$.\label{fig:pi0gamma_mgg}}
      \end{figure}
    \end{minipage}
    \hspace{1em}%
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{pi0gamma_chi2}
        \vspace{-0.2cm}%
        \caption{$\chi^2$ кинематической реконструкции.\label{fig:pi0gamma_chi2}}
      \end{figure}
    \end{minipage}
    \begin{minipage}{0.45\linewidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.8\linewidth]{pi0gamma_z}
        \vspace{-0.2cm}%
        \caption{$Z$-координата вершины.\label{fig:pi0gamma_z}}
      \end{figure}
    \end{minipage}
  \end{frame}

  \begin{frame}{Моделирование $e^+e^-\rightarrow\eta\pi^+\pi^-,
      \eta\rightarrow\gamma\gamma$}
    Розыгрыш одного и того же события с использованием матриц ошибок
    частиц ($5\times10^{4}$ раз). Кинематическая реконструкция разыгранных
    событий в гипотезе $e^+e^-\rightarrow\pi^+\pi^-\gamma\gamma$.
    
    \includegraphics[width=0.55\linewidth]{kinfit_etapipi_montecarlo}
  \end{frame}

  \begin{frame}{Получение исходного кода}
    \footnotesize
    \begin{block}{Предварительные шаги}
      \begin{itemize}
      \item Создать директорию, в которой будет храниться исходный код.
      \item Перейти в эту директорию.
      \end{itemize}
    \end{block}
    \begin{block}{Пакет оптимизации}
      git clone \textcolor{blue}{\url{https://github.com/sergeigribanov/ccgo}}
    \end{block}
    \begin{block}{Пакет базовых классов кинематической реконструкции}
      git clone \textcolor{blue}{\url{https://github.com/sergeigribanov/KFBase}}
    \end{block}
    \begin{block}{Пакет кинематической реконструкции для детектора КМД-3}
      git clone \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd}}
    \end{block}
  \end{frame}
  
  \begin{frame}{Подготовка к установке}
    \footnotesize
    \begin{itemize}
    \item Скачать исходный код пакетов CCGO, KFBase, KFCmd (см. предыдущий
      слайд).
    \item Далее в презентации в демонстрационных целях будем считать, что
      исходный код пакетов хранится в директории
      \textcolor{blue}{/sl19cmd/sgribanov/source}.
    \item Предполагается, что установлен фреймворк ROOT (C++11).
    \item Настроить переменные окружения фреймворка ROOT. Например, так\\
      source <префикс ROOT>/bin/thisroot.sh
    \item Предполагается, что установлен пакет Eigen3. Далее предполагается, что
      пакет Eigen3 установлен верно в том смысле, что в CMake его можно найти с
      помощью find\_package. В противном случае путь к Eigen3 можно указать с
      помощью специальной опции при вызове cmake.
    \item Создать директорию для сборки пакетов, например,
      \textcolor{blue}{/sl19cmd/sgribanov/build}. В этой директории создать поддиректории
      ccgo, KFBase, KFCmd.
    \item Создать директорию, в которую будут установлены
      пакеты. Например, \textcolor{blue}{/spoolA/sgribanov/packages}.
    \end{itemize}
  \end{frame}

  \begin{frame}{Установка пакета оптимизации CCGO}
    \footnotesize
    \textbf{Зависимости:} Eigen3.\\
    \textbf{Установка (пути необходимо переименовать):}
    \begin{enumerate}
    \item Перейти в директорию, предназначенную для сборки пакета CCGO (не
      путать с директорией, содержащей исходный код).\\
      cd /store19/sgribanov/build/ccgo
    \item Вызвать следующую команду:\\
      cmake -DCMAKE\_INSTALL\_PREFIX=/spoolA/sgribanov/packages/ccgo
      /sl19cmd/sgribanov/source/ccgo\\
      С помощью опции DCMAKE\_INSTALL\_PREFIX указывается директория, в которую
      будет установлен пакет. Последний путь в строке команды --- путь к
      директории, содержащей исходный код пакета.
    \item make
    \item make install
    \end{enumerate}
  \end{frame}

  \begin{frame}{Установка пакета KFBase}
    \footnotesize
    \textbf{Зависимости:} Eigen3, ROOT, CCGO.\\
    \textbf{Установка (пути необходимо переименовать):}
    \begin{enumerate}
    \item Перейти в директорию, предназначенную для сборки пакета KFBase.\\
      cd /store19/sgribanov/build/KFBase
    \item Вызвать следующую команду:\\
      cmake -DCMAKE\_INSTALL\_PREFIX=/spoolA/sgribanov/packages/KFBase
      /sl19cmd/sgribanov/source/KFBase\\
      Здесь /spoolA/sgribanov/packages/KFBase --- директория, в которую будет
      установлен пакет KFBase. В директории /sl19cmd/sgribanov/source/KFBase
      хранится исходный код пакета KFBase.
    \item make
    \item make install
    \end{enumerate}
  \end{frame}

  \begin{frame}{Установка пакета KFCmd}
    \footnotesize
    \textbf{Зависимости:} Eigen3, ROOT, CCGO, KFBase.\\
    \textbf{Установка (пути необходимо переименовать):}
    \begin{enumerate}
    \item Перейти в директорию, предназначенную для сборки пакета KCmd.\\
      cd /store19/sgribanov/build/KFCmd
    \item Вызвать следующую команду:\\
      cmake -DCMAKE\_INSTALL\_PREFIX=/spoolA/sgribanov/packages/KFCmd
      /sl19cmd/sgribanov/source/KFCmd\\
      Здесь /spoolA/sgribanov/packages/KFCmd --- директория, в которую будет
      установлен пакет KFCmd. В директории /sl19cmd/sgribanov/source/KFCmd
      хранится исходный код пакета KFCmd.
    \item make
    \item make install
    \end{enumerate}
  \end{frame}

  \begin{frame}{Пакеты уже установлены на кластере КМД-3}
    \textbf{Префиксы:}\\
    /spoolA/sgribanov/packages/ccgo\\
    /spoolA/sgribanov/packages/KFBase\\
    /spoolA/sgribanov/packages/KFCmd
  \end{frame}

  \begin{frame}{Настройка окружения}
    \textbf{Простой способ:} скопировать файл
    /spoolA/sgribanov/packages/KFCmd/env/rootlogon.C в свою рабочую директорию
    или скопировать содержимое этого файла в уже имеющийся rootlogon.C. В
    рабочей директории также необходимо создать файлы пользовательской программы
    реконструкции. \textit{Примеры:}\\
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmdKsKs2ChPi}},\\
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmdKsKpi}},\\
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmdKsKlPi0}}.\\

    \textbf{При использовании CMake} в собственной программе кинематической
    реконструкции пакеты KFCmd, KFBase, CCGO находятся
    автоматически. Однако перед запуском исполняемого файла необходимо настроить
    переменные окружения. \textit{Пример:}
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd5Pi}}.
  \end{frame}

  \begin{frame}{Гипотезы}
    \footnotesize
    \begin{itemize}
    \item Далее под гипотезой подразумевается совокупность вершин, частиц и
      условий, а также их состояний (включены, выключены, фиксированы, свободны).
    \item Некоторые гипотезы уже заданы в пакете KFCmd: $\pi^+\pi^-\gamma\gamma$,
      $K_sK^+\pi^-,\,K_s\rightarrow\pi^+\pi^-$,
      $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$,
      $K_sK_s\pi^+\pi^-,\,K_s\rightarrow\pi^+\pi^-$,
      $\gamma\gamma\gamma$, $\pi^+\pi^-\pi^+\pi^-$ и др.
      Пример гипотезы $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$:
      \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/Hypo3ChPionsKMinus.cpp}}.
    \item С програмной точки зрения гипотеза представляет собой класс,
      отнаслеованный от класса Hypothesis из пакета KFCmd.
      \item У класса гипотезы необходио реализовать только конструктор, где
        создаются вершины, частицы и условия.
      \item \textbf{Законы сохранения энергии-импульса} для конечных частиц
        выполняются по умолчанию.
    \item Пользователь всегда может создать собственную гипотезу вне пакета
      KFCmd (будет рассказано далее).
    \item Пользователь может обратиться с просьбой о добавлении конкретной
      гипотезы в пакет KFCmd.
    \end{itemize}
  \end{frame}

  \begin{frame}{Устройство гипотезы $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$}
    \footnotesize 
   Далее будет рассказано про устройство гипотезы на примере гипотезы $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$:
      \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/Hypo3ChPionsKMinus.cpp}}. Приведенный
      ниже код содержится в теле конструктора.
     \inputminted[mathescape=true]{cpp}{\code/HypoKsKplusPiMinus.cpp}
   \end{frame}

   \begin{frame}{Устройство гипотезы $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$ (продолжение)}
     \footnotesize
     Метод \textbf{addChargedParticle} добавляет заряженную частицу в
     гипотезу. Список имеющихся заряженных частиц:
     \begin{itemize}
     \item KFCmd::Electron --- $e^-$,
     \item KFCmd::Positron --- $e^+$,
     \item KFCmd::Muon --- $\mu^-$,
     \item KFCmd::AntiMuon --- $\mu^+$,
     \item KFCmd::PiMinusMeson --- $\pi^-$,
     \item KFCmd::PiPlusMeson --- $\pi^+$,
     \item KFCmd::KMinusMeson --- $K^-$,
     \item KFCmd::KPlusMeson --- $K^+$,
     \item Пользовательская заряженная частица: \textbf{ChargedParticle(} \textit{имя},
       \textit{масса} в МэВах, \textit{заряд} в ед. элементарного\textbf{)}.
     \end{itemize}
     Для всех частиц, кроме пользовательской, массы берутся из PDG.
   \end{frame}
  
   \begin{frame}{Устройство гипотезы $K_sK^-\pi^+,\,K_s\rightarrow\pi^+\pi^-$ (продолжение)}
     \footnotesize
     Метод \textbf{addVertexConstraintsXYZ(}``pi+\_1'', ``vtx0''\textbf{)} добавляет
     условия на то, что вершина "vtx0" лежит на треке заряженной частицы
     ``pi+\_1''.

     В приведенной выше гипотезе предполагается, что $K_S$-мезон вылетает из
     вершины ``vtx0'' и распадается в вершине ``vtx1''. Чтобы избежать лишних
     параметров $K_S$-мезон в гипотезе непосредственно не задается.

     На угол $\alpha$ между импульсом $K_S$-мезона и суммарным импульсом продуктов его
     распада накладывается условие $\alpha=0$ (вернее условия на коллинеарность,
     описаны выше). Для этого с помощью метода
     \textbf{addFlowConstraintsXYZ(}``ks-flow'', ``vtx0'', ``vtx1''\textbf{)} создается
     соответствующий набор из трех условий. Здесь ``ks-flow'' --- имя группы
     условий (выбирается пользователем).

     Продукты распада добавляются с помощью вызова методов:
     \inputminted[mathescape=true]{cpp}{\code/ksdecayproducts.cpp}
   \end{frame}

   \begin{frame}{Устройство гипотезы $\pi^+\pi^-\gamma\gamma$}
     \footnotesize
     Пример гипотезы $\pi^+\pi^-\gamma\gamma$
     \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/Hypo2ChPions2Photons.cpp}}:
     \inputminted[mathescape=true]{cpp}{\code/Hypo2ChPions2Photons.cpp}
   \end{frame}

   \begin{frame}{Устройство гипотезы $\pi^+\pi^-\pi^+\pi^-\gamma\gamma$}
     \footnotesize
     Пример гипотезы $\pi^+\pi^-\pi^+\pi^-\gamma\gamma$
     \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/Hypo4ChPions2Photons.cpp}}:
     \inputminted[mathescape=true]{cpp}{\code/Hypo4ChPions2Photons.cpp}
   \end{frame}

   \begin{frame}{Устройство гипотезы $\pi^+\pi^-\pi^+\pi^-\gamma\gamma$ (продолжение)}
     \footnotesize
     Метод \textbf{addMassConstraint(}\textit{имя условия}, \textit{масса} в МэВах,
     \textit{множество частиц}\textbf{)} добавляет условие на инвариантную массу
     группы частиц. Имя условия (в данном случае ``m-pi0-constraint'')
     выбирается пользователем.

     Метод \textbf{disableConstraint(}имя условия\textbf{)} предназначен для
     отключения единичного (в смысле единственное) условия по его имени. Необходимо отметить, что группу
     условий таким образом отключить нельзя. Примером группы условий являются
     условия на вершину или условия на коллинеарность импульса распадной частицы
     суммарному импульсу ее продуктов распада. Как при необходимости отключить
     такие условия будет рассказано далее.

     Таким образом, \textit{условие на инвариантную массу} в гипотезе формально
     отсутствует. Однако его при необходимости можно включить в коде
     пользовательской программы реконструкции, превратив гипотезу
     $\pi^+\pi^-\pi^+\pi^-\gamma\gamma$ в гипотезу
     $\pi^+\pi^-\pi^+\pi^-\pi^0,\,\pi^0\rightarrow\gamma\gamma$. Предположим,
     что объект гипотезы называется \textbf{hypo}. Тогда условие с именем
     ``m-pi0-constraint'' можно включить так
     \textbf{hypo}.\textbf{enableConstraint(}``m-pi0-constraint''\textbf{)}.
   \end{frame}

   \begin{frame}{Устройство гипотезы $K_sK_L\pi^0$}
     \footnotesize
     Пример гипотезы с потерянной частицей $K_L$
     \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/HypoKsKlPi0.cpp}}:
     \inputminted[mathescape=true]{cpp}{\code/HypoKsKlPi0.cpp}
   \end{frame}

   \begin{frame}{Устройство гипотезы $K_sK_L\pi^0$ (продолжение)}
     \footnotesize
     \inputminted[mathescape=true]{cpp}{\code/HypoKsKlPi0-2.cpp}
     \textbf{Замечание.} Если необходимо добавить потерянный фотон, то делать
     это нужно иным образом. Чтобы не возникало проблемм, связанных с
     вычислением первых и вторых производных, четырех-импульсы безмассовых
     частиц задаются следующим образом: $\mathcal{P}=(E, E\sin\theta\sin\phi,
     E\sin\theta\cos\phi, E\cos\theta)$. Добавить такую частицу можно с помощью
     метода \textbf{addParticleMassLessThetaPhiE(}\textit{имя
       частицы}\textit{)}. Так как обратная матрица ошибок по умолчанию нулевая,
     то частица является потерянной.
   \end{frame}
   
   \begin{frame}{Использование пакета KFCmd, интеграция с TrPh}
     \footnotesize
    Для удобства использования пакет кинематической реконструкции для КМД-3
    адоптирован для работы с tr\_ph деревьями. Для этого в пакет кинематической
    реконструкции для детектора КМД-3 KFCmd добавлен абстрактный класс TrPh с
    описанием параметров дерева:
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/include/TrPh.hpp}}.
    При появлении новых версий tr\_ph этот класс необходимо будет обновлять.

    В простейшем случае, при написании пользовательской программы реконструкции,
    необходимо отнаследовать собственный класс TrPh от класса KFCmd::TrPh (класс
    TrPh из пакета KFCmd). Необходимо вставить имплементацию метода
    \textbf{Loop}, создать конструктор и деструктор (см. образец в примере).
    Также можно вставить имплементацию метода \textbf{Cut} и
    собсвтенных методов при необходимости.

    Интеграция с TrPh скрывает от пользователя заполнение параметров и обратных
    матриц ошибок этих параметров для фотонов и заряженных частиц.
  \end{frame}

  \begin{frame}{Использование пакета KFCmd, схема простейшей программы}
    \footnotesize
    Будет рассмотрена программа кинематической реконструкции событий процесса
    $K_sK_l\pi^0,\pi^0\rightarrow\gamma\gamma$. Гипотеза:
    \textcolor{blue}{\url{https://github.com/sergeigribanov/KFCmd/blob/master/src/HypoKsKlPi0.cpp}}
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-2.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-3.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-4.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-5.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-6.cpp}
  \end{frame}

  \begin{frame}{Схема простейшей программы (продолжение)}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/simpliest-program-7.cpp}
    Заполнять параметры потерянной частицы $K_L$ нет необходимости.
  \end{frame}

  \begin{frame}{Получение импульсов и масс}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/getting-parameters.cpp}
  \end{frame}

  \begin{frame}{Получение координат вершин}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/getting-parameters-2.cpp}
  \end{frame}

  \begin{frame}{Получение параметров}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/getting-parameters-3.cpp}
  \end{frame}

  \begin{frame}{Получение кода ошибки и $\chi^2$}
    \footnotesize
    \inputminted[mathescape=true]{cpp}{\code/chi2-error-codes.cpp}
  \end{frame}

  \begin{frame}{Включение / выключение условий}
    \footnotesize
    Включить / выключить условие / группу условий можно, например, перед циклом
    по событиям.
    \inputminted[mathescape=true]{cpp}{\code/enable-disable-constraints.cpp}
  \end{frame}

  \begin{frame}[standout]
    Спасибо за внимание!
  \end{frame}

  \appendix
  
\end{document}